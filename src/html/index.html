<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<script type="text/javascript" src="./eventemitter2.min.js"></script>
	<script type="text/javascript" src="./roslib.min.js"></script>
	<script type="text/javascript" src="./jquery.min.js"></script>
	<script type="text/javascript" src="./virtualjoystick.js"></script>

	<style>
		body {
			overflow: hidden;
			padding: 0;
			margin: 0;
			background-color: #BBB;
	
		#info {
			position: absolute;
			top: 0px;
			width: 100%;
			padding: 5px;
			text-align: center;
		}
		#info a {
			color: #66F;
			text-decoration: none;
		}
		#info a:hover {
			text-decoration: underline;
		}
		#container {
			width: 100%;
			height: 100%;
			overflow: hidden;
			padding: 0;
			margin: 0;
			-webkit-user-select: none;
			-moz-user-select: none;
		}
	</style>
</head>

<body>
	<div id="container" >
		<center>
			<h3>Fox7 Virtual Teleop Frontview</h3>
				<form>
					<input type="button" value="Start">

			</form>
			<p>Running</p>




		</center>
	</div>
	<div id="container2">	
	<center>
		<div style="width:200px;height:200px;border:1px solid #000;" id="container1">
			

		</div>
	</center>
	</div>

	<div id="text_zone">
		<center>
			
			 <form>
				  Coef 1 : <input type="text" name="coef1" id="coef1" maxlenght="4" size="4"><br>
				  Coef 2 : <input type="text" name="coef2" id="coef2" maxlength="4" size="4"><br>
				  <input type="button" id="submit" value="Submit" >
			</form> 
			
		</center>
	</div>

	<script type="text/javascript">
		var ros = new ROSLIB.Ros({
	    		url : 'ws://10.42.0.1:9090'
	  	});


		ros.on('connection', function() {
			console.log('Connected to websocket server.');
		});

		ros.on('error', function(error) {
			console.log('Error connecting to websocket server: ', error);
		});

		ros.on('close', function() {
			console.log('Connection to websocket server closed.');
		});
		
		var control = new ROSLIB.Topic({
			ros : ros,
			name : '/controlee',
			messageType : 'std_msgs/Float32'
		});
		
		
		var btn = document.querySelector('input');
		var txt = document.querySelector('p');

		btn.addEventListener('click', updateBtn);

		function updateBtn(){
			var str;
			if(btn.value === 'Start'){
				btn.value = 'Stop';
				txt.textContent = 'Running';
				str = 'Start'
			}
			else{
				btn.value = 'Start';
				txt.textContent = 'Stand by';
				str = 'Stop'
			}

			var str_msgs = new ROSLIB.Message({
				data: 5.2 
			});
			control.publish(str_msgs);
		}


		var cmdVel = new ROSLIB.Topic({
			ros: ros,
			name: '/cmd',
			messageType: 'geometry_msgs/Twist'
		});

		console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");
		
		var joystick = new VirtualJoystick({
			container: document.getElementById('container2'),
			mouseSupport: true,
			stationaryBase: false,
		//baseX: window.innerWidth /2,
			baseX: window.innerWidth / 2 ,
			baseY: window.innerHeight /1.4,
			//baseY: window.innerHeight /1.4,
			limitStickTravel: true,
			stickRadius: window.innerWidth / 4,
			strokeStyle: 'red'
		});

		joystick.addEventListener('touchStart', function() {})
		joystick.addEventListener('touchEnd', function() {})
		

		setInterval(function() {
			var outputEl = document.getElementById('result');
			var scale = 100;
			var maxspeed = 1.0;
			var X = Math.round(joystick.deltaY());
			var Z = Math.round(joystick.deltaX());
			// Convert to ROS coordinates
			LinearX = (X / scale) * (-1);
			AngularZ = (Z / scale) * (-1);
			// Limit to max speed
			if (LinearX > maxspeed) {
				LinearX = maxspeed;
			}
			if (LinearX < -maxspeed) {
				LinearX = -maxspeed;
			}
			if (AngularZ > maxspeed) {
				AngularZ = maxspeed;
			}
			if (AngularZ < -maxspeed) {
				AngularZ = -maxspeed;
			}
			twist = new ROSLIB.Message({
				"linear": {
					x: LinearX,
					y: 0.0,
					z: 0.0
				},
				"angular": {
					x: 0.0,
					y: 0.0,
					z: AngularZ
				}
			});
			//console.log('X:' + twist.linear.x + ' Z:' + twist.angular.z);

			cmdVel.publish(twist);
		}, 1 / 30 * 1000);
		
	/*coeff_asserv = new ROSLIB.Topic({
		ros : ros,
		name : '/coeff_asserv',
		messageType : 'std_msgs/Float32'
	});*/
		var coeff_asserv = new ROSLIB.Topic({
			ros : ros,
			name : '/coeff_asserv',
			messageType : 'std_msgs/Float32'
		});

		var coef1 = document.getElementById("coef1").value;
		var coef2 = document.getElementById("coef2").value;
		document.getElementById("submit").onclick = displayCoef;		

		function displayCoef(){
			coef1 = document.getElementById("coef1").value;
			coef2 = document.getElementById("coef2").value;
			console.log(coef1,coef2);
			var coeff_arr = [parseFloat(coef1) , parseFloat(coef2)];
 
			var coef_msgs = new ROSLIB.Message({
				data: parseFloat(coef1)
			});
                         coeff_asserv.publish(coef_msgs);

		}
		 
	</script>


</body>

</html>
